import com.fasterxml.jackson.databind.*;
import com.fasterxml.jackson.databind.node.*;

import java.io.File;
import java.util.UUID;

public class JsonFileAppender {

    private static final ObjectMapper MAPPER = new ObjectMapper()
            .enable(SerializationFeature.INDENT_OUTPUT); // 보기 좋은 포맷 출력

    /**
     * files 배열의 특정 인덱스 항목을 복사하여
     * 값 일부를 변경한 뒤 files 배열의 마지막에 추가.
     */
    public static void appendFileBlock(String inputPath, String outputPath, int templateIndex) throws Exception {
        // 1) JSON 파일 읽기
        ObjectNode root = (ObjectNode) MAPPER.readTree(new File(inputPath));

        // 2) files 배열 얻기
        JsonNode filesNode = root.path("files");
        if (!(filesNode instanceof ArrayNode files)) {
            throw new IllegalStateException("'files' 필드가 배열이 아닙니다.");
        }

        if (templateIndex < 0 || templateIndex >= files.size()) {
            throw new IllegalArgumentException("templateIndex가 범위를 벗어났습니다.");
        }

        // 3) 복사할 원본 항목 선택 및 deep copy
        ObjectNode template = (ObjectNode) files.get(templateIndex);
        ObjectNode newFile = template.deepCopy();

        // 4) 필요한 필드 값 채우기
        newFile.put("path", "/new/path/example.txt");
        newFile.put("newpath", "/new/path/example.txt");
        newFile.put("contenttype", "text/plain");
        newFile.put("description", "자동 추가된 파일 블록");
        newFile.put("author", "kim.jy");
        newFile.put("metadataForFile", "meta info");
        newFile.put("excluded", false);
        newFile.put("id", UUID.randomUUID().toString()); // 고유 ID 필드 예시

        // 예시: manualDependencies, tags 같은 배열 필드 교체
        ArrayNode manualDeps = MAPPER.createArrayNode();
        manualDeps.add("/lib/util.jar");
        manualDeps.add("/lib/core.jar");
        newFile.set("manualDependencies", manualDeps);

        ArrayNode tags = MAPPER.createArrayNode();
        tags.add(MAPPER.createObjectNode()
                .put("namespace", "module")
                .put("value", "core"));
        tags.add(MAPPER.createObjectNode()
                .put("namespace", "purpose")
                .put("value", "demo"));
        newFile.set("tags", tags);

        // 5) 배열의 마지막에 추가
        files.add(newFile);

        // 6) 결과 파일 저장
        MAPPER.writeValue(new File(outputPath), root);
        System.out.println("✅ 새로운 files 항목이 추가되었습니다: " + outputPath);
    }

    // 실행 예시
    public static void main(String[] args) {
        try {
            appendFileBlock("input.json", "output.json", 0);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
